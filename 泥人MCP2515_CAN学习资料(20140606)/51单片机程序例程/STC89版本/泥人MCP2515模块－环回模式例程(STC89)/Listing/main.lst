C51 COMPILER V9.00   MAIN                                                                  05/22/2017 17:26:20 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Output\main.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c LARGE BROWSE INCDIR(.\BSP\Delay;.\BSP\UART;.\BSP\MCP2515) DEBUG OBJE
                    -CTEXTEND PRINT(.\Listing\main.lst) OBJECT(.\Output\main.obj)

line level    source

   1          /**********************************************************************************
   2           * ¹¤³ÌÃû  £ºÄàÈËMCP2515Ä£¿é£­»·»ØÄ£Ê½Àı³Ì
   3           * ÃèÊö    £ºµçÄÔÍ¨¹ı"´®¿Úµ÷ÊÔÖúÊÖ"Èí¼ş¸øµ¥Æ¬»ú´®¿Ú1·¢ËÍÊı¾İ£¬´®¿Ú1½ÓÊÕµ½Êı¾İºó
   4           *                       ÔÙÍ¨¹ıCANÄ£¿é¸øCANÄ£¿é×Ô¼º·¢ËÍÊı¾İ£»CANÄ£¿é½ÓÊÕµ½µÄCANÊı¾İÍ¨¹ıµ¥
   5           *                       Æ¬»ú´®¿Ú1·¢ËÍµ½µçÄÔ¡£  
   6           * ÊµÑéÆ½Ì¨£ºNiRen_STC/IAP15ºËĞÄ°å(»òÓÃ»§STC15µ¥Æ¬»ú¿ª·¢°å) + NiRen_MCP2515 CANÄ£¿é
   7           * Ó²¼şÁ¬½Ó£º  P2^3 -> MCP2515_SCK              SPIÊ±ÖÓÒı½Å 
   8           *                         P2^2 -> MCP2515_MOSI         SPIÖ÷»úÊä³ö´Ó»úÊäÈëÒı½Å 
   9           *                         P2^1 -> MCP2515_MISO         SPIÖ÷»úÊäÈë´Ó»úÊä³öÒı½Å 
  10           *                         P2^0 -> MCP2515_CS           SPIÆ¬Ñ¡Òı½Å 
  11           *                         P3^3 -> MCP2515_INT          MCP2515ÖĞ¶ÏÒı½Å 
  12           * ×÷Õß    £ºÄàÈËÍ¨ĞÅÄ£¿é¿ª·¢ÍÅ¶Ó
  13           * ²©¿Í    £ºhttp://nirenelec.blog.163.com
  14           * ÌÔ±¦    £ºhttp://nirenelec.taobao.com
  15          **********************************************************************************/
  16          
  17          /*********************************************************************************/
  18          /*×¢Òâ£º±¾Àı³ÌÊÇ»ùÓÚSTC89ÏµÁĞ´«Í³ĞÍ12T 51µ¥Æ¬»ú±àĞ´£¬ÓÉÓÚ²»Í¬ÏµÁĞ51µ¥Æ¬»úÒ»Ğ©ÍâÉè*/
  19          /*¹¦ÄÜÅäÖÃ´æÔÚ²îÒì£¬ÇëÇ×ÃÇÔÚÊ¹ÓÃÊ±¶ÔÓ¦½øĞĞĞŞ¸Ä¡£*/
  20          /*********************************************************************************/
  21          
  22          /*********************************** »·»ØÄ£Ê½ ************************************/
  23          /*»·»ØÄ£Ê½ÔÊĞíÆ÷¼şÄÚ²¿µÄ·¢ËÍ»º³åÆ÷ºÍ½ÓÊÕ»º³åÆ÷Ö®¼ä½øĞĞ±¨ÎÄµÄ×Ô·¢×ÔÊÕ,¶øÎŞĞèÍ¨¹ıCAN
  24          ×ÜÏß¡£´ËÄ£Ê½¿ÉÓÃÓÚÏµÍ³¿ª·¢ºÍ²âÊÔ¡£»·»ØÄ£Ê½ÏÂ£¬È·ÈÏÎ»ACK ÎŞĞ§£¬Æ÷¼ş½ÓÊÕ×Ô¼º·¢ËÍµÄ±¨
  25          ÎÄ¾ÍÏóÔÚ½ÓÊÕÀ´×ÔÆäËû½ÚµãµÄ±¨ÎÄ¡£»·»ØÄ£Ê½ÊÇÒ»ÖÖ°²¾²Ä£Ê½£¬¼´Æ÷¼şÔÚ´ËÄ£Ê½ÏÂ²»»á·¢ËÍÈÎ
  26          ºÎ±¨ÎÄ£¨°üÀ¨´íÎó±êÖ¾»òÈ·ÈÏĞÅºÅ£©¡£¸ÃÄ£Ê½ÏÂTXCAN Òı½Å´¦ÓÚÒşĞÔ×´Ì¬¡£*/
  27          
  28          #include <reg52.h>
  29          #include "MCP2515.H"
  30          
  31          //#define FOSC 11059200L                        //ÏµÍ³ÆµÂÊ
  32          #define FOSC 10000000L                  //ÏµÍ³ÆµÂÊ
  33          #define T1MS (65536-FOSC/12/1000)       //¶¨Ê±Æ÷¹¤×÷ÔÚ12TÄ£Ê½ÏÂ¶¨Ê±1msµÄ¼ÆÊıÆ÷Öµ(Ğ´ÈëTHx¡¢TLxµÄÖµ)
  34          #define BAUD 9600                               //´®¿Ú1²¨ÌØÂÊ
  35          #define UART1_Rx_Buff_LEN 100   //´®¿Ú1Êı¾İ»º³åÇøÊı¾İ³¤¶È
  36          
  37          bit busy=0;                                                                                     //´®¿Ú1·¢ËÍÊı¾İÃ¦±êÖ¾Î»
  38          unsigned char UART1_Rx_Buffer[UART1_Rx_Buff_LEN];       //´®¿Ú1½ÓÊÕ±£´æ»º³åÇø
  39          unsigned char Uart1_Delay=0;                                            //´®¿Ú1½ÓÊÕÊı¾İÖ¡ÑÓÊ±(ms)£¬ÑÓÊ±Ê±¼äµ½µ±1Ö¡Êı¾İ½ÓÊÕÍê³É
  40          unsigned char Uart1_Write_Count=0;                                      //Ğ´´®¿Ú1»º³åÇøÖ¸Õë
  41          unsigned char Uart1_Read_Count=0;                                       //¶Á´®¿Ú1»º³åÇøÖ¸Õë
  42          unsigned char Uart1_Finish=0;                                           //µ±Ç°Ò»Ö¡Êı¾İ½ÓÊÕÍê³É±êÖ¾
  43          
  44          unsigned char CAN_Flag=0;                                                       //CAN½ÓÊÕµ½Êı¾İ±êÖ¾
  45          unsigned char CAN_R_Buffer[8];                                          //CAN½ÓÊÕÊı¾İ±£´æ»º³åÇø
  46          
  47          /*******************************************************************************
  48          * º¯ÊıÃû  : Timer0_Init
  49          * ÃèÊö    : ¶¨Ê±Æ÷0³õÊ¼»¯ÅäÖÃ
  50          * ÊäÈë    : ÎŞ
  51          * Êä³ö    : ÎŞ
  52          * ·µ»ØÖµ  : ÎŞ
  53          * ËµÃ÷    : ÎŞ
  54          *******************************************************************************/
C51 COMPILER V9.00   MAIN                                                                  05/22/2017 17:26:20 PAGE 2   

  55          void Timer0_Init(void)
  56          {
  57   1              TMOD &= 0xF0;
  58   1          TMOD |= 0x01;               //ÉèÖÃ¶¨Ê±Æ÷ÎªÄ£Ê½1(16Î»Ä£Ê½)
  59   1          TL0 = T1MS;                 //³õÊ¼»¯¼ÆÊ±Öµ
  60   1          TH0 = T1MS >> 8;
  61   1          TR0 = 1;                    //¶¨Ê±Æ÷0¿ªÊ¼¼ÆÊ±
  62   1          ET0 = 1;                    //Ê¹ÄÜ¶¨Ê±Æ÷0ÖĞ¶Ï
  63   1          EA = 1;                             //Ê¹ÄÜ×ÜÖĞ¶Ï                                                    
  64   1      }
  65          
  66          /*******************************************************************************
  67          * º¯ÊıÃû  : Timer0_ISR
  68          * ÃèÊö    : ¶¨Ê±Æ÷0ÖĞ¶Ï·şÎñº¯Êı
  69          * ÊäÈë    : ÎŞ
  70          * Êä³ö    : ÎŞ
  71          * ·µ»ØÖµ  : ÎŞ
  72          * ËµÃ÷    : ±¾³ÌĞòÓÃÓÚ¼ì²â1Ö¡´®¿ÚÊı¾İ½ÓÊÕÍê³É
  73          *******************************************************************************/
  74          void Timer0_ISR() interrupt 1 using 1
  75          {
  76   1              if(Uart1_Delay>0)
  77   1              {
  78   2                      Uart1_Delay--;
  79   2                      if(Uart1_Delay==0)
  80   2                      {
  81   3                              //ÑÓÊ±Ê±¼äµ½ÔÙÃ»ÓĞ½ÓÊÕµ½ĞÂµÄ´®¿ÚÊı¾İ£¬±íÊ¾1Ö¡Êı¾İ½ÓÊÕÍê³É
  82   3                              if(Uart1_Write_Count != Uart1_Read_Count) Uart1_Finish=1;
  83   3                      }
  84   2              }
  85   1      
  86   1          TL0 = T1MS;                 //³õÊ¼»¯¼ÆÊ±Öµ
  87   1          TH0 = T1MS >> 8;
  88   1      }
  89          
  90          /*******************************************************************************
  91          * º¯ÊıÃû  : Exint1_Init
  92          * ÃèÊö    : Íâ²¿ÖĞ¶Ï1³õÊ¼»¯º¯Êı
  93          * ÊäÈë    : ÎŞ
  94          * Êä³ö    : ÎŞ
  95          * ·µ»ØÖµ  : ÎŞ
  96          * ËµÃ÷    : ÎŞ
  97          *******************************************************************************/
  98          void Exint1_Init(void)
  99          {
 100   1          PX1=1;              //ÉèÖÃÍâ²¿ÖĞ¶Ï1µÄÖĞ¶ÏÓÅÏÈ¼¶Îª¸ßÓÅÏÈ¼¶
 101   1          IT1 = 1;    //ÉèÖÃINT1µÄÖĞ¶ÏÀàĞÍ (1:½öÏÂ½µÑØ 0:ÉÏÉıÑØºÍÏÂ½µÑØ)
 102   1          EX1 = 1;    //Ê¹ÄÜINT1ÖĞ¶Ï
 103   1          EA = 1;     //Ê¹ÄÜ×ÜÖĞ¶Ï
 104   1      }
 105          
 106          
 107          /*******************************************************************************
 108          * º¯ÊıÃû  : Exint1_ISR
 109          * ÃèÊö    : Íâ²¿ÖĞ¶Ï1ÖĞ¶Ï·şÎñº¯Êı
 110          * ÊäÈë    : ÎŞ
 111          * Êä³ö    : ÎŞ
 112          * ·µ»ØÖµ  : ÎŞ
 113          * ËµÃ÷    : ÓÃÓÚ¼ì²âMCP2515ÖĞ¶ÏÒı½ÅµÄÖĞ¶ÏĞÅºÅ
 114          *******************************************************************************/
 115          void Exint1_ISR(void) interrupt 2 using 1
 116          {
C51 COMPILER V9.00   MAIN                                                                  05/22/2017 17:26:20 PAGE 3   

 117   1              CAN_Flag=1;//CAN½ÓÊÕµ½Êı¾İ±êÖ¾
 118   1      }
 119          
 120          /*******************************************************************************
 121          * º¯ÊıÃû  : UART1_Init_Config
 122          * ÃèÊö    : UART1³õÊ¼»¯ÅäÖÃ
 123          * ÊäÈë    : ÎŞ
 124          * Êä³ö    : ÎŞ
 125          * ·µ»ØÖµ  : ÎŞ
 126          * ËµÃ÷    : ÎŞ
 127          *******************************************************************************/
 128          void UART1_Init_Config(void)    
 129          {
 130   1              SCON = 0x50;            //8Î»Êı¾İ,¿É±ä²¨ÌØÂÊ
 131   1              TMOD &= 0x0F;           //Çå³ı¶¨Ê±Æ÷1Ä£Ê½Î»
 132   1              TMOD |= 0x20;           //Éè¶¨¶¨Ê±Æ÷1Îª8Î»×Ô¶¯ÖØ×°·½Ê½
 133   1              TH1 = TL1 = -(FOSC/12/32/BAUD);//Éè¶¨¶¨Ê±1³õÖµ 
 134   1              TR1 = 1;                        //Æô¶¯¶¨Ê±Æ÷1
 135   1          ES = 1;                             //Ê¹ÄÜ´®¿ÚÖĞ¶Ï        
 136   1          EA = 1;                             //Ê¹ÄÜ×ÜÖĞ¶Ï
 137   1      }
 138          
 139          /*******************************************************************************
 140          * º¯ÊıÃû  : UART1_Buffer_PntAdd
 141          * ÃèÊö    : ¶Á¡¢Ğ´´®¿Ú1»º³åÇøÖ¸Õë¼Ó1 
 142          * ÊäÈë    : *pnt(Ö¸Ïò´®¿Ú1¶Á¡¢Ğ´´®¿Ú1»º³åÇøÖ¸Õë)
 143          * Êä³ö    : ÎŞ
 144          * ·µ»ØÖµ  : ÎŞ
 145          * ËµÃ÷    : ÎŞ
 146          *******************************************************************************/
 147          void UART1_Buffer_PntAdd(unsigned char *pnt)
 148          {
 149   1              *pnt+=1;
 150   1              if(*pnt >= UART1_Rx_Buff_LEN) *pnt=0;
 151   1      }
 152          
 153          /*******************************************************************************
 154          * º¯ÊıÃû  : UART1_ISR
 155          * ÃèÊö    : UART1ÖĞ¶Ï·şÎñº¯Êı
 156          * ÊäÈë    : ÎŞ
 157          * Êä³ö    : ÎŞ
 158          * ·µ»ØÖµ  : ÎŞ
 159          * ËµÃ÷    : ÎŞ
 160          *******************************************************************************/
 161          void UART1_ISR(void) interrupt 4 using 1
 162          {
 163   1              unsigned char ch;
 164   1              //½ÓÊÕÊı¾İ
 165   1              if(RI)
 166   1              {
 167   2                      RI = 0;//Çå³ıRIÎ»
 168   2                      ch=SBUF;
 169   2                      UART1_Rx_Buffer[Uart1_Write_Count]=ch;  //½«½ÓÊÕµ½µÄÊı¾İĞ´Èë»º³åÇø
 170   2                      UART1_Buffer_PntAdd(&Uart1_Write_Count);//Ğ´´®¿Ú1»º³åÇøÖ¸Õë¼Ó1                  
 171   2                      if(Uart1_Write_Count == Uart1_Read_Count)//Èç¹û¶Á¡¢Ğ´»º³åÇøÖ¸ÕëÖØµş,Ôò¶ÁÖ¸Õë¼Ó1,ÕâÊ±½«¶ªÊ§1¸ö×Ö½ÚÊı¾İ
 172   2                      {
 173   3                              UART1_Buffer_PntAdd(&Uart1_Read_Count);//¶Á´®¿Ú1»º³åÇøÖ¸Õë¼Ó1
 174   3                      }
 175   2                      Uart1_Delay = 20;//´®¿Ú1½ÓÊÕÊı¾İÖ¡ÑÓÊ±(ms)£¬ÑÓÊ±Ê±¼äµ½µ±1Ö¡Êı¾İ½ÓÊÕÍê³É
 176   2              }
 177   1              //·¢ËÍÊı¾İ
 178   1              if (TI)                 
C51 COMPILER V9.00   MAIN                                                                  05/22/2017 17:26:20 PAGE 4   

 179   1              {
 180   2                      TI = 0;         //Çå³ıTIÎ»
 181   2                      busy = 0;       //ÇåÃ¦±êÖ¾(1Ã¦,0¿ÕÏĞ)
 182   2              }
 183   1      }
 184          
 185          /*******************************************************************************
 186          * º¯ÊıÃû  : UART1_SendData
 187          * ÃèÊö    : UART1·¢ËÍÒ»¸ö×Ö½Ú
 188          * ÊäÈë    : dat£º´ı·¢ËÍÊı¾İ
 189          * Êä³ö    : ÎŞ
 190          * ·µ»ØÖµ  : ÎŞ
 191          * ËµÃ÷    : ÎŞ
 192          *******************************************************************************/
 193          void UART1_SendData(unsigned char dat)
 194          {
 195   1          while (busy);       //µÈ´ıÇ°ÃæµÄÊı¾İ·¢ËÍÍê³É
 196   1          busy = 1;           //´®¿Ú1·¢ËÍÊı¾İÃ¦±êÖ¾Î»(1Ã¦,0¿ÕÏĞ)
 197   1          SBUF = dat;         //Ğ´Êı¾İµ½UARTÊı¾İ¼Ä´æÆ÷
 198   1      }
 199          
 200          /*******************************************************************************
 201          * º¯ÊıÃû  : UART1_SendBuffer
 202          * ÃèÊö    : UART1·¢ËÍÒ»¸ö»º³åÇøÊı¾İ
 203          * ÊäÈë    : *buff£º´ı·¢ËÍ»º³åÇøÊ×µØÖ·,len£º´ı·¢ËÍÊı¾İ³¤¶È
 204          * Êä³ö    : ÎŞ
 205          * ·µ»ØÖµ  : ÎŞ
 206          * ËµÃ÷    : ÎŞ
 207          *******************************************************************************/
 208          void UART1_SendBuffer(unsigned char *buff,unsigned int len)
 209          {
 210   1              unsigned int i=0;
 211   1      
 212   1              if(len<=0) return;
 213   1      
 214   1              do
 215   1              {
 216   2                      UART1_SendData(buff[i++]);//·¢ËÍµ±Ç°×Ö·û
 217   2              }while(i<len);
 218   1      }
 219          
 220          /*******************************************************************************
 221          * º¯ÊıÃû  : CAN_Send_Dispose
 222          * ÃèÊö    : CAN·¢ËÍ´®¿Ú1½ÓÊÕµ½µÄÊı¾İ´¦Àíº¯Êı
 223          * ÊäÈë    : ÎŞ
 224          * Êä³ö    : ÎŞ
 225          * ·µ»ØÖµ  : ÎŞ
 226          * ËµÃ÷    : ÎŞ
 227          *******************************************************************************/
 228          void CAN_Send_Dispose(void)
 229          {
 230   1              unsigned char i=0,len=0,write=0,buff[8];
 231   1              
 232   1              write = Uart1_Write_Count;
 233   1              if(Uart1_Write_Count<Uart1_Read_Count) write+=UART1_Rx_Buff_LEN;
 234   1              
 235   1              if((write-Uart1_Read_Count) >= 8)//Èç¹û´®¿Ú1½ÓÊÕ»º³åÇøÖĞÎ´¶ÁÊı¾İ´óÓÚ8¸ö×Ö½Ú,ÔòÍ¨¹ıCAN×ÜÏß·¢ËÍ8¸ö×Ö½ÚÊı¾İ(
             -CAN·¢ËÍÒ»Ö¡±¨ÎÄ×î´ó8¸ö×Ö½Ú)
 236   1              {                       
 237   2                      len = 8;                                                        
 238   2              }
 239   1              else if(Uart1_Finish == 1)//Èç¹û´®¿Ú1½ÓÊÕ»º³åÇøÖĞÎ´¶ÁÊı¾İĞ¡ÓÚ8¸ö×Ö½Ú,ÇÒÔÙÒ²Ã»½ÓÊÕµ½´®¿ÚµÄÊı¾İ,ÔòCAN·¢ËÍÊ£
C51 COMPILER V9.00   MAIN                                                                  05/22/2017 17:26:20 PAGE 5   

             -ÓàµÄÊı¾İ
 240   1              {
 241   2                      len = write-Uart1_Read_Count;
 242   2                      Uart1_Finish=0;//µ±Ç°Ò»Ö¡Êı¾İ½ÓÊÕÍê³É±êÖ¾                       
 243   2              }
 244   1              else return;//Èç¹û´®¿Ú1½ÓÊÕ»º³åÇøÖĞÎ´¶ÁÊı¾İĞ¡ÓÚ8¸ö×Ö½Ú,ÇÒ»¹ÔÚ½ÓÊÕ´®¿ÚµÄÊı¾İÔòCANÏÈ²»·¢Êı¾İ,µÈ¹»8¸ö×Ö½ÚÁËÔ
             -Ù·¢
 245   1      
 246   1              for(i=0;i<len;i++)
 247   1              {
 248   2                      buff[i] = UART1_Rx_Buffer[Uart1_Read_Count];//½«´®¿Ú½ÓÊÕ»º³åÇøµÄÊı¾İ¸´ÖÆµ½CAN·¢ËÍÁÙÊ±»º³åÇøbuff
 249   2                      UART1_Buffer_PntAdd(&Uart1_Read_Count);//¶Á´®¿Ú1»º³åÇøÖ¸Õë¼Ó1
 250   2              }       
 251   1              CAN_Send_Buffer(buff,len);//CAN·¢ËÍÖ¸¶¨³¤¶ÈµÄÊı¾İ
 252   1      }
 253          
 254          /*******************************************************************************
 255          * º¯ÊıÃû  : main
 256          * ÃèÊö    : Ö÷º¯Êı£¬ÓÃ»§³ÌĞò´Ómainº¯Êı¿ªÊ¼ÔËĞĞ
 257          * ÊäÈë    : ÎŞ
 258          * Êä³ö    : ÎŞ
 259          * ·µ»ØÖµ  : ÎŞ
 260          * ËµÃ÷    : ÎŞ
 261          *******************************************************************************/
 262          void main(void)
 263          {
 264   1              Timer0_Init();                  //¶¨Ê±Æ÷0³õÊ¼»¯ÅäÖÃ
 265   1              UART1_Init_Config();    //UART1³õÊ¼»¯ÅäÖÃ
 266   1              Exint1_Init();                  //Íâ²¿ÖĞ¶Ï1³õÊ¼»¯º¯Êı
 267   1              MCP2515_Init();                 //MCP2515³õÊ¼»¯ÅäÖÃ
 268   1                                      
 269   1              while(1)
 270   1              {
 271   2                      if(Uart1_Write_Count != Uart1_Read_Count)//Èç¹û¶ÁÖ¸Õë²»µÈĞ´Ö¸Õë,ÔòÖ¤Ã÷´®¿Ú1½ÓÊÕµ½Êı¾İ
 272   2                      {
 273   3                              CAN_Send_Dispose();//CAN·¢ËÍ´®¿Ú1½ÓÊÕµ½µÄÊı¾İ´¦Àíº¯Êı
 274   3                      }
 275   2                      else if(Uart1_Finish == 1) Uart1_Finish = 0;
 276   2                      
 277   2                      while((CAN_Flag==1) || ((P3&0x08) == 0))        
 278   2                      {
 279   3                              unsigned char len;
 280   3      
 281   3                              CAN_Flag=0;//CAN½ÓÊÕµ½Êı¾İ±êÖ¾
 282   3                              len = CAN_Receive_Buffer(CAN_R_Buffer);//CAN½ÓÊÕÒ»Ö¡Êı¾İ
 283   3                              if(len != 0)
 284   3                              UART1_SendBuffer(CAN_R_Buffer,len);//UART1·¢ËÍÒ»¸ö»º³åÇøÊı¾İ
 285   3                      }       
 286   2              }
 287   1      }
 288          
 289          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    520    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    113      15
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
C51 COMPILER V9.00   MAIN                                                                  05/22/2017 17:26:20 PAGE 6   

END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)

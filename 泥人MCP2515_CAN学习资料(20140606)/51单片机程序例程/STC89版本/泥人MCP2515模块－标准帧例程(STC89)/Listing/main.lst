C51 COMPILER V9.00   MAIN                                                                  05/23/2017 16:46:02 PAGE 1   


C51 COMPILER V9.00, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Output\main.obj
COMPILER INVOKED BY: C:\Keil\C51\BIN\C51.EXE main.c LARGE BROWSE INCDIR(.\BSP\Delay;.\BSP\UART;.\BSP\MCP2515) DEBUG OBJE
                    -CTEXTEND PRINT(.\Listing\main.lst) OBJECT(.\Output\main.obj)

line level    source

   1          /**********************************************************************************
   2           * ¹¤³ÌÃû  £ºÄàÈËMCP2515Ä£¿é£­±ê×¼Ö¡Àı³Ì
   3           * ÃèÊö    £ºµçÄÔÍ¨¹ı"´®¿Úµ÷ÊÔÖúÊÖ"Èí¼ş¸øµ¥Æ¬»ú´®¿Ú1·¢ËÍÊı¾İ£¬´®¿Ú1½ÓÊÕµ½Êı¾İºó
   4           *                       ÔÙÍ¨¹ıCANÄ£¿é·¢ËÍµ½ÁíÒ»¸öCANÄ£¿é£»Í¬Ê±CANÄ£¿é½ÓÊÕµ½µÄCANÊı¾İÍ¨¹ıµ¥
   5           *                       Æ¬»ú´®¿Ú1·¢ËÍµ½µçÄÔ¡£  
   6           * ÊµÑéÆ½Ì¨£ºNiRen_STC/IAP15ºËĞÄ°å(»òÓÃ»§STC15µ¥Æ¬»ú¿ª·¢°å) + NiRen_MCP2515 CANÄ£¿é
   7           * Ó²¼şÁ¬½Ó£º  P2^3 -> MCP2515_SCK              SPIÊ±ÖÓÒı½Å 
   8           *                         P2^2 -> MCP2515_MOSI         SPIÖ÷»úÊä³ö´Ó»úÊäÈëÒı½Å 
   9           *                         P2^1 -> MCP2515_MISO         SPIÖ÷»úÊäÈë´Ó»úÊä³öÒı½Å 
  10           *                         P2^0 -> MCP2515_CS           SPIÆ¬Ñ¡Òı½Å 
  11           *                         P3^3 -> MCP2515_INT          MCP2515ÖĞ¶ÏÒı½Å 
  12           * ×÷Õß    £ºÄàÈËÍ¨ĞÅÄ£¿é¿ª·¢ÍÅ¶Ó
  13           * ²©¿Í    £ºhttp://nirenelec.blog.163.com
  14           * ÌÔ±¦    £ºhttp://nirenelec.taobao.com
  15          **********************************************************************************/
  16          
  17          /*********************************************************************************/
  18          /*×¢Òâ£º±¾Àı³ÌÊÇ»ùÓÚSTC89ÏµÁĞ´«Í³ĞÍ12T 51µ¥Æ¬»ú±àĞ´£¬ÓÉÓÚ²»Í¬ÏµÁĞ51µ¥Æ¬»úÒ»Ğ©ÍâÉè*/
  19          /*¹¦ÄÜÅäÖÃ´æÔÚ²îÒì£¬ÇëÇ×ÃÇÔÚÊ¹ÓÃÊ±¶ÔÓ¦½øĞĞĞŞ¸Ä¡£*/
  20          /*********************************************************************************/
  21          
  22          #include <reg52.h>
  23          #include "MCP2515.H"
  24          
  25          #define FOSC 11059200L                  //ÏµÍ³ÆµÂÊ
  26          #define T1MS (65536-FOSC/12/1000)       //¶¨Ê±Æ÷¹¤×÷ÔÚ12TÄ£Ê½ÏÂ¶¨Ê±1msµÄ¼ÆÊıÆ÷Öµ(Ğ´ÈëTHx¡¢TLxµÄÖµ)
  27          #define BAUD 9600                               //´®¿Ú1²¨ÌØÂÊ
  28          #define UART1_Rx_Buff_LEN 100   //´®¿Ú1Êı¾İ»º³åÇøÊı¾İ³¤¶È
  29          
  30          bit busy=0;                                                                                     //´®¿Ú1·¢ËÍÊı¾İÃ¦±êÖ¾Î»
  31          unsigned char UART1_Rx_Buffer[UART1_Rx_Buff_LEN];       //´®¿Ú1½ÓÊÕ±£´æ»º³åÇø
  32          unsigned char Uart1_Delay=0;                                            //´®¿Ú1½ÓÊÕÊı¾İÖ¡ÑÓÊ±(ms)£¬ÑÓÊ±Ê±¼äµ½µ±1Ö¡Êı¾İ½ÓÊÕÍê³É
  33          unsigned char Uart1_Write_Count=0;                                      //Ğ´´®¿Ú1»º³åÇøÖ¸Õë
  34          unsigned char Uart1_Read_Count=0;                                       //¶Á´®¿Ú1»º³åÇøÖ¸Õë
  35          unsigned char Uart1_Finish=0;                                           //µ±Ç°Ò»Ö¡Êı¾İ½ÓÊÕÍê³É±êÖ¾
  36          
  37          unsigned char CAN_Flag=0;                                                       //CAN½ÓÊÕµ½Êı¾İ±êÖ¾
  38          unsigned char CAN_R_Buffer[8];                                          //CAN½ÓÊÕÊı¾İ±£´æ»º³åÇø
  39          
  40          /*******************************************************************************
  41          * º¯ÊıÃû  : Timer0_Init
  42          * ÃèÊö    : ¶¨Ê±Æ÷0³õÊ¼»¯ÅäÖÃ
  43          * ÊäÈë    : ÎŞ
  44          * Êä³ö    : ÎŞ
  45          * ·µ»ØÖµ  : ÎŞ
  46          * ËµÃ÷    : ÎŞ
  47          *******************************************************************************/
  48          void Timer0_Init(void)
  49          {
  50   1              TMOD &= 0xF0;
  51   1          TMOD |= 0x01;               //ÉèÖÃ¶¨Ê±Æ÷ÎªÄ£Ê½1(16Î»Ä£Ê½)
  52   1          TL0 = T1MS;                 //³õÊ¼»¯¼ÆÊ±Öµ
  53   1          TH0 = T1MS >> 8;
  54   1          TR0 = 1;                    //¶¨Ê±Æ÷0¿ªÊ¼¼ÆÊ±
C51 COMPILER V9.00   MAIN                                                                  05/23/2017 16:46:02 PAGE 2   

  55   1          ET0 = 1;                    //Ê¹ÄÜ¶¨Ê±Æ÷0ÖĞ¶Ï
  56   1          EA = 1;                             //Ê¹ÄÜ×ÜÖĞ¶Ï                                                    
  57   1      }
  58          
  59          /*******************************************************************************
  60          * º¯ÊıÃû  : Timer0_ISR
  61          * ÃèÊö    : ¶¨Ê±Æ÷0ÖĞ¶Ï·şÎñº¯Êı
  62          * ÊäÈë    : ÎŞ
  63          * Êä³ö    : ÎŞ
  64          * ·µ»ØÖµ  : ÎŞ
  65          * ËµÃ÷    : ±¾³ÌĞòÓÃÓÚ¼ì²â1Ö¡´®¿ÚÊı¾İ½ÓÊÕÍê³É
  66          *******************************************************************************/
  67          void Timer0_ISR() interrupt 1 using 1
  68          {
  69   1              if(Uart1_Delay>0)
  70   1              {
  71   2                      Uart1_Delay--;
  72   2                      if(Uart1_Delay==0)
  73   2                      {
  74   3                              //ÑÓÊ±Ê±¼äµ½ÔÙÃ»ÓĞ½ÓÊÕµ½ĞÂµÄ´®¿ÚÊı¾İ£¬±íÊ¾1Ö¡Êı¾İ½ÓÊÕÍê³É
  75   3                              if(Uart1_Write_Count != Uart1_Read_Count) Uart1_Finish=1;
  76   3                      }
  77   2              }
  78   1      
  79   1          TL0 = T1MS;                 //³õÊ¼»¯¼ÆÊ±Öµ
  80   1          TH0 = T1MS >> 8;
  81   1      }
  82          
  83          /*******************************************************************************
  84          * º¯ÊıÃû  : Exint1_Init
  85          * ÃèÊö    : Íâ²¿ÖĞ¶Ï1³õÊ¼»¯º¯Êı
  86          * ÊäÈë    : ÎŞ
  87          * Êä³ö    : ÎŞ
  88          * ·µ»ØÖµ  : ÎŞ
  89          * ËµÃ÷    : ÎŞ
  90          *******************************************************************************/
  91          void Exint1_Init(void)
  92          {
  93   1          PX1=1;              //ÉèÖÃÍâ²¿ÖĞ¶Ï1µÄÖĞ¶ÏÓÅÏÈ¼¶Îª¸ßÓÅÏÈ¼¶
  94   1          IT1 = 1;    //ÉèÖÃINT1µÄÖĞ¶ÏÀàĞÍ (1:½öÏÂ½µÑØ 0:ÉÏÉıÑØºÍÏÂ½µÑØ)
  95   1          EX1 = 1;    //Ê¹ÄÜINT1ÖĞ¶Ï
  96   1          EA = 1;     //Ê¹ÄÜ×ÜÖĞ¶Ï
  97   1      }
  98          
  99          
 100          /*******************************************************************************
 101          * º¯ÊıÃû  : Exint1_ISR
 102          * ÃèÊö    : Íâ²¿ÖĞ¶Ï1ÖĞ¶Ï·şÎñº¯Êı
 103          * ÊäÈë    : ÎŞ
 104          * Êä³ö    : ÎŞ
 105          * ·µ»ØÖµ  : ÎŞ
 106          * ËµÃ÷    : ÓÃÓÚ¼ì²âMCP2515ÖĞ¶ÏÒı½ÅµÄÖĞ¶ÏĞÅºÅ
 107          *******************************************************************************/
 108          void Exint1_ISR(void) interrupt 2 using 1
 109          {
 110   1              CAN_Flag=1;//CAN½ÓÊÕµ½Êı¾İ±êÖ¾
 111   1      }
 112          
 113          /*******************************************************************************
 114          * º¯ÊıÃû  : UART1_Init_Config
 115          * ÃèÊö    : UART1³õÊ¼»¯ÅäÖÃ
 116          * ÊäÈë    : ÎŞ
C51 COMPILER V9.00   MAIN                                                                  05/23/2017 16:46:02 PAGE 3   

 117          * Êä³ö    : ÎŞ
 118          * ·µ»ØÖµ  : ÎŞ
 119          * ËµÃ÷    : ÎŞ
 120          *******************************************************************************/
 121          void UART1_Init_Config(void)    
 122          {
 123   1              SCON = 0x50;            //8Î»Êı¾İ,¿É±ä²¨ÌØÂÊ
 124   1              TMOD &= 0x0F;           //Çå³ı¶¨Ê±Æ÷1Ä£Ê½Î»
 125   1              TMOD |= 0x20;           //Éè¶¨¶¨Ê±Æ÷1Îª8Î»×Ô¶¯ÖØ×°·½Ê½
 126   1              TH1 = TL1 = -(FOSC/12/32/BAUD);//Éè¶¨¶¨Ê±1³õÖµ 
 127   1              TR1 = 1;                        //Æô¶¯¶¨Ê±Æ÷1
 128   1          ES = 1;                             //Ê¹ÄÜ´®¿ÚÖĞ¶Ï        
 129   1          EA = 1;                             //Ê¹ÄÜ×ÜÖĞ¶Ï
 130   1      }
 131          
 132          /*******************************************************************************
 133          * º¯ÊıÃû  : UART1_Buffer_PntAdd
 134          * ÃèÊö    : ¶Á¡¢Ğ´´®¿Ú1»º³åÇøÖ¸Õë¼Ó1 
 135          * ÊäÈë    : *pnt(Ö¸Ïò´®¿Ú1¶Á¡¢Ğ´´®¿Ú1»º³åÇøÖ¸Õë)
 136          * Êä³ö    : ÎŞ
 137          * ·µ»ØÖµ  : ÎŞ
 138          * ËµÃ÷    : ÎŞ
 139          *******************************************************************************/
 140          void UART1_Buffer_PntAdd(unsigned char *pnt)
 141          {
 142   1              *pnt+=1;
 143   1              if(*pnt >= UART1_Rx_Buff_LEN) *pnt=0;
 144   1      }
 145          
 146          /*******************************************************************************
 147          * º¯ÊıÃû  : UART1_ISR
 148          * ÃèÊö    : UART1ÖĞ¶Ï·şÎñº¯Êı
 149          * ÊäÈë    : ÎŞ
 150          * Êä³ö    : ÎŞ
 151          * ·µ»ØÖµ  : ÎŞ
 152          * ËµÃ÷    : ÎŞ
 153          *******************************************************************************/
 154          void UART1_ISR(void) interrupt 4 using 1
 155          {
 156   1              unsigned char ch;
 157   1              //½ÓÊÕÊı¾İ
 158   1              if(RI)
 159   1              {
 160   2                      RI = 0;//Çå³ıRIÎ»
 161   2                      ch=SBUF;
 162   2                      UART1_Rx_Buffer[Uart1_Write_Count]=ch;  //½«½ÓÊÕµ½µÄÊı¾İĞ´Èë»º³åÇø
 163   2                      UART1_Buffer_PntAdd(&Uart1_Write_Count);//Ğ´´®¿Ú1»º³åÇøÖ¸Õë¼Ó1                  
 164   2                      if(Uart1_Write_Count == Uart1_Read_Count)//Èç¹û¶Á¡¢Ğ´»º³åÇøÖ¸ÕëÖØµş,Ôò¶ÁÖ¸Õë¼Ó1,ÕâÊ±½«¶ªÊ§1¸ö×Ö½ÚÊı¾İ
 165   2                      {
 166   3                              UART1_Buffer_PntAdd(&Uart1_Read_Count);//¶Á´®¿Ú1»º³åÇøÖ¸Õë¼Ó1
 167   3                      }
 168   2                      Uart1_Delay = 20;//´®¿Ú1½ÓÊÕÊı¾İÖ¡ÑÓÊ±(ms)£¬ÑÓÊ±Ê±¼äµ½µ±1Ö¡Êı¾İ½ÓÊÕÍê³É
 169   2              }
 170   1              //·¢ËÍÊı¾İ
 171   1              if (TI)                 
 172   1              {
 173   2                      TI = 0;         //Çå³ıTIÎ»
 174   2                      busy = 0;       //ÇåÃ¦±êÖ¾(1Ã¦,0¿ÕÏĞ)
 175   2              }
 176   1      }
 177          
 178          /*******************************************************************************
C51 COMPILER V9.00   MAIN                                                                  05/23/2017 16:46:02 PAGE 4   

 179          * º¯ÊıÃû  : UART1_SendData
 180          * ÃèÊö    : UART1·¢ËÍÒ»¸ö×Ö½Ú
 181          * ÊäÈë    : dat£º´ı·¢ËÍÊı¾İ
 182          * Êä³ö    : ÎŞ
 183          * ·µ»ØÖµ  : ÎŞ
 184          * ËµÃ÷    : ÎŞ
 185          *******************************************************************************/
 186          void UART1_SendData(unsigned char dat)
 187          {
 188   1          while (busy);       //µÈ´ıÇ°ÃæµÄÊı¾İ·¢ËÍÍê³É
 189   1          busy = 1;           //´®¿Ú1·¢ËÍÊı¾İÃ¦±êÖ¾Î»(1Ã¦,0¿ÕÏĞ)
 190   1          SBUF = dat;         //Ğ´Êı¾İµ½UARTÊı¾İ¼Ä´æÆ÷
 191   1      }
 192          
 193          /*******************************************************************************
 194          * º¯ÊıÃû  : UART1_SendBuffer
 195          * ÃèÊö    : UART1·¢ËÍÒ»¸ö»º³åÇøÊı¾İ
 196          * ÊäÈë    : *buff£º´ı·¢ËÍ»º³åÇøÊ×µØÖ·,len£º´ı·¢ËÍÊı¾İ³¤¶È
 197          * Êä³ö    : ÎŞ
 198          * ·µ»ØÖµ  : ÎŞ
 199          * ËµÃ÷    : ÎŞ
 200          *******************************************************************************/
 201          void UART1_SendBuffer(unsigned char *buff,unsigned int len)
 202          {
 203   1              unsigned int i=0;
 204   1      
 205   1              if(len<=0) return;
 206   1      
 207   1              do
 208   1              {
 209   2                      UART1_SendData(buff[i++]);//·¢ËÍµ±Ç°×Ö·û
 210   2              }while(i<len);
 211   1      }
 212          
 213          /*******************************************************************************
 214          * º¯ÊıÃû  : CAN_Send_Dispose
 215          * ÃèÊö    : CAN·¢ËÍ´®¿Ú1½ÓÊÕµ½µÄÊı¾İ´¦Àíº¯Êı
 216          * ÊäÈë    : ÎŞ
 217          * Êä³ö    : ÎŞ
 218          * ·µ»ØÖµ  : ÎŞ
 219          * ËµÃ÷    : ÎŞ
 220          *******************************************************************************/
 221          void CAN_Send_Dispose(void)
 222          {
 223   1              unsigned char i=0,len=0,write=0,buff[8];
 224   1              
 225   1              write = Uart1_Write_Count;
 226   1              if(Uart1_Write_Count<Uart1_Read_Count) write+=UART1_Rx_Buff_LEN;
 227   1              
 228   1              if((write-Uart1_Read_Count) >= 8)//Èç¹û´®¿Ú1½ÓÊÕ»º³åÇøÖĞÎ´¶ÁÊı¾İ´óÓÚ8¸ö×Ö½Ú,ÔòÍ¨¹ıCAN×ÜÏß·¢ËÍ8¸ö×Ö½ÚÊı¾İ(
             -CAN·¢ËÍÒ»Ö¡±¨ÎÄ×î´ó8¸ö×Ö½Ú)
 229   1              {                       
 230   2                      len = 8;                                                        
 231   2              }
 232   1              else if(Uart1_Finish == 1)//Èç¹û´®¿Ú1½ÓÊÕ»º³åÇøÖĞÎ´¶ÁÊı¾İĞ¡ÓÚ8¸ö×Ö½Ú,ÇÒÔÙÒ²Ã»½ÓÊÕµ½´®¿ÚµÄÊı¾İ,ÔòCAN·¢ËÍÊ£
             -ÓàµÄÊı¾İ
 233   1              {
 234   2                      len = write-Uart1_Read_Count;
 235   2                      Uart1_Finish=0;//µ±Ç°Ò»Ö¡Êı¾İ½ÓÊÕÍê³É±êÖ¾                       
 236   2              }
 237   1              else return;//Èç¹û´®¿Ú1½ÓÊÕ»º³åÇøÖĞÎ´¶ÁÊı¾İĞ¡ÓÚ8¸ö×Ö½Ú,ÇÒ»¹ÔÚ½ÓÊÕ´®¿ÚµÄÊı¾İÔòCANÏÈ²»·¢Êı¾İ,µÈ¹»8¸ö×Ö½ÚÁËÔ
             -Ù·¢
C51 COMPILER V9.00   MAIN                                                                  05/23/2017 16:46:02 PAGE 5   

 238   1      
 239   1              for(i=0;i<len;i++)
 240   1              {
 241   2                      buff[i] = UART1_Rx_Buffer[Uart1_Read_Count];//½«´®¿Ú½ÓÊÕ»º³åÇøµÄÊı¾İ¸´ÖÆµ½CAN·¢ËÍÁÙÊ±»º³åÇøbuff
 242   2                      UART1_Buffer_PntAdd(&Uart1_Read_Count);//¶Á´®¿Ú1»º³åÇøÖ¸Õë¼Ó1
 243   2              }       
 244   1              CAN_Send_Buffer(buff,len);//CAN·¢ËÍÖ¸¶¨³¤¶ÈµÄÊı¾İ
 245   1      }
 246          
 247          /*******************************************************************************
 248          * º¯ÊıÃû  : main
 249          * ÃèÊö    : Ö÷º¯Êı£¬ÓÃ»§³ÌĞò´Ómainº¯Êı¿ªÊ¼ÔËĞĞ
 250          * ÊäÈë    : ÎŞ
 251          * Êä³ö    : ÎŞ
 252          * ·µ»ØÖµ  : ÎŞ
 253          * ËµÃ÷    : ÎŞ
 254          *******************************************************************************/
 255          void main(void)
 256          {
 257   1              Timer0_Init();                  //¶¨Ê±Æ÷0³õÊ¼»¯ÅäÖÃ
 258   1              UART1_Init_Config();    //UART1³õÊ¼»¯ÅäÖÃ
 259   1              Exint1_Init();                  //Íâ²¿ÖĞ¶Ï1³õÊ¼»¯º¯Êı
 260   1              MCP2515_Init();                 //MCP2515³õÊ¼»¯ÅäÖÃ
 261   1                                      
 262   1              while(1)
 263   1              {
 264   2                      if(Uart1_Write_Count != Uart1_Read_Count)//Èç¹û¶ÁÖ¸Õë²»µÈĞ´Ö¸Õë,ÔòÖ¤Ã÷´®¿Ú1½ÓÊÕµ½Êı¾İ
 265   2                      {
 266   3                              CAN_Send_Dispose();//CAN·¢ËÍ´®¿Ú1½ÓÊÕµ½µÄÊı¾İ´¦Àíº¯Êı
 267   3                      }
 268   2                      else if(Uart1_Finish == 1) Uart1_Finish = 0;
 269   2                      
 270   2                      while((CAN_Flag==1) || ((P3&0x08) == 0))        
 271   2                      {
 272   3                              unsigned char len;
 273   3      
 274   3                              CAN_Flag=0;//CAN½ÓÊÕµ½Êı¾İ±êÖ¾
 275   3                              len = CAN_Receive_Buffer(CAN_R_Buffer);//CAN½ÓÊÕÒ»Ö¡Êı¾İ
 276   3                              if(len != 0)
 277   3                              UART1_SendBuffer(CAN_R_Buffer,len);//UART1·¢ËÍÒ»¸ö»º³åÇøÊı¾İ
 278   3                      }       
 279   2              }
 280   1      }
 281          
 282          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    520    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =    113      15
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
